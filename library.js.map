{"version":3,"file":"library.js","sources":["../src/js/components/user-list.js"],"sourcesContent":["import { genres, getGenres } from '../helpers/genres';\nimport { getMovieById, getMoviesByIds } from '../helpers/movies-api';\nimport { refs } from '../helpers/refs';\nimport { modalTemplate, updateModalBtn } from '../helpers/render-function';\nimport {\n  clearLibrary,\n  getLibraryIds,\n  LIBRARY_UPDATED_EVENT,\n  removeLibraryMovie,\n} from '../helpers/library';\nimport { showModal } from './modal';\n\nconst state = {\n  movies: [],\n  filter: 'all',\n};\n\ndocument.addEventListener('DOMContentLoaded', () => {\n  if (!refs.userList) return;\n  initUserLibrary();\n});\n\nfunction initUserLibrary() {\n  populateGenreFilter();\n  attachUserListEvents();\n  renderLibrary();\n}\n\nfunction populateGenreFilter() {\n  if (!refs.userListFilter) return;\n  const options = ['all', ...genres.map(genre => genre.id)];\n  refs.userListFilter.innerHTML = options\n    .map(option => {\n      if (option === 'all') {\n        return `<option value=\"all\">All genres</option>`;\n      }\n      const genreItem = genres.find(item => item.id === option);\n      return `<option value=\"${option}\">${genreItem?.name ?? 'Unknown'}</option>`;\n    })\n    .join('');\n}\n\nfunction attachUserListEvents() {\n  refs.userListFilter?.addEventListener('change', e => {\n    state.filter = e.target.value;\n    applyFilter();\n  });\n\n  refs.userListClear?.addEventListener('click', () => {\n    clearLibrary();\n  });\n\n  refs.userListEmptyLink?.addEventListener('click', e => {\n    const action = e.currentTarget.dataset.action;\n    if (action === 'browse' || !action) {\n      return;\n    }\n    e.preventDefault();\n    if (action === 'reset-filter') {\n      resetFilter();\n    }\n    if (action === 'retry') {\n      renderLibrary();\n    }\n  });\n\n  refs.userList?.addEventListener('click', handleUserListClick);\n  window.addEventListener(LIBRARY_UPDATED_EVENT, renderLibrary);\n}\n\nasync function renderLibrary() {\n  if (!refs.userList) return;\n  const ids = getLibraryIds();\n  toggleClearButton(ids.length > 0);\n\n  if (!ids.length) {\n    state.movies = [];\n    refs.userList.innerHTML = '';\n    toggleEmptyState(true, 'empty');\n    return;\n  }\n\n  try {\n    const movies = await getMoviesByIds(ids);\n    state.movies = movies;\n    applyFilter();\n  } catch (error) {\n    console.error('Failed to load saved movies', error);\n    state.movies = [];\n    refs.userList.innerHTML = '';\n    toggleEmptyState(true, 'error');\n  }\n}\n\nfunction applyFilter() {\n  if (!refs.userList) return;\n  if (!state.movies.length) {\n    toggleEmptyState(true, 'empty');\n    return;\n  }\n\n  const targetGenre = state.filter;\n  const filteredMovies =\n    targetGenre === 'all'\n      ? state.movies\n      : state.movies.filter(movie => movieMatchesGenre(movie, targetGenre));\n\n  refs.userList.innerHTML = filteredMovies.map(libraryCardTemplate).join('');\n  const reason = filteredMovies.length ? null : 'filter';\n  toggleEmptyState(!filteredMovies.length, reason);\n}\n\nfunction movieMatchesGenre(movie, genreId) {\n  const normalizedId = Number(genreId);\n  if (Number.isNaN(normalizedId)) {\n    return true;\n  }\n  const genresSource = movie.genres || movie.genre_ids || [];\n  return genresSource.some(genre => {\n    if (typeof genre === 'number') {\n      return genre === normalizedId;\n    }\n    return genre.id === normalizedId;\n  });\n}\n\nfunction libraryCardTemplate(movie) {\n  const releaseYear = movie.release_date ? movie.release_date.slice(0, 4) : 'N/A';\n  const genresLabel = movie.genres\n    ? movie.genres.map(item => item.name).join(', ')\n    : getGenres(movie.genre_ids);\n  const overview = formatOverview(movie.overview);\n  const rating = movie.vote_average ? Number(movie.vote_average).toFixed(1) : '—';\n  const votes = movie.vote_count ?? '0';\n  const posterPath = movie.poster_path || movie.backdrop_path;\n  const poster = posterPath\n    ? `https://image.tmdb.org/t/p/w500/${posterPath}`\n    : 'https://placehold.co/300x450/0f172a/ffffff?text=No+Poster';\n\n  return `<li class=\"user-card\" data-id=\"${movie.id}\">\n      <div class=\"user-card-media\">\n        <img src=\"${poster}\" alt=\"${movie.title} poster\" class=\"user-card-poster\" loading=\"lazy\" />\n      </div>\n      <div class=\"user-card-body\">\n        <div class=\"user-card-header\">\n          <h3 class=\"user-card-title\">${movie.title}</h3>\n          <span class=\"user-card-year\">${releaseYear}</span>\n        </div>\n        <p class=\"user-card-genres\">${genresLabel}</p>\n        <p class=\"user-card-overview\">${overview}</p>\n        <div class=\"user-card-stats\">\n          <span>⭐ ${rating}</span>\n          <span>Votes ${votes}</span>\n        </div>\n        <div class=\"user-card-actions\">\n          <button class=\"btn btn--ghost js-library-details\" type=\"button\" data-id=\"${movie.id}\">\n            Details\n          </button>\n          <button class=\"btn user-card-remove js-library-remove\" type=\"button\" data-id=\"${movie.id}\">\n            Remove\n          </button>\n        </div>\n      </div>\n    </li>`;\n}\n\nfunction handleUserListClick(e) {\n  const removeBtn = e.target.closest('.js-library-remove');\n  if (removeBtn) {\n    const movieId = removeBtn.dataset.id;\n    removeLibraryMovie(movieId);\n    return;\n  }\n\n  const detailsBtn = e.target.closest('.js-library-details');\n  if (!detailsBtn) return;\n\n  openMovieModal(detailsBtn.dataset.id);\n}\n\nasync function openMovieModal(id) {\n  if (!id) return;\n  if (!refs.modalContent) return;\n  try {\n    const movie = await getMovieById(id);\n    const markup = modalTemplate(movie);\n    refs.modalContent.innerHTML = markup;\n    updateModalBtn(id);\n    showModal();\n  } catch (error) {\n    console.error('Failed to open movie modal', error);\n  }\n}\n\nfunction toggleEmptyState(isEmpty, reason = 'empty') {\n  if (!refs.userListEmpty) return;\n  refs.userListEmpty.hidden = !isEmpty;\n  if (!isEmpty) {\n    return;\n  }\n\n  const title = refs.userListEmpty.querySelector('.user-list-empty-title');\n  const text = refs.userListEmpty.querySelector('.user-list-empty-text');\n  const link = refs.userListEmptyLink;\n\n  if (reason === 'filter') {\n    title.textContent = 'No movies match this genre';\n    text.textContent = 'Try a different filter to explore the rest of your saved movies.';\n    if (link) {\n      link.textContent = 'Reset filter';\n      link.href = '#';\n      link.dataset.action = 'reset-filter';\n    }\n  } else if (reason === 'error') {\n    title.textContent = 'Something went wrong';\n    text.textContent = 'Please try again later.';\n    if (link) {\n      link.textContent = 'Try again';\n      link.href = '#';\n      link.dataset.action = 'retry';\n    }\n  } else {\n    title.textContent = 'Library is empty';\n    text.textContent = 'Start adding movies from the catalog to see them listed here.';\n    if (link) {\n      link.textContent = 'Browse catalog';\n      link.href = '/catalog.html';\n      link.dataset.action = 'browse';\n    }\n  }\n}\n\nfunction toggleClearButton(enabled) {\n  if (!refs.userListClear) return;\n  refs.userListClear.disabled = !enabled;\n}\n\nfunction resetFilter() {\n  if (!refs.userListFilter) return;\n  refs.userListFilter.value = 'all';\n  state.filter = 'all';\n  applyFilter();\n}\n\nfunction formatOverview(text = '') {\n  if (!text) {\n    return 'No synopsis available yet.';\n  }\n  return text.length > 220 ? `${text.slice(0, 217)}...` : text;\n}\n"],"names":["state","refs","initUserLibrary","populateGenreFilter","attachUserListEvents","renderLibrary","options","genres","genre","option","genreItem","item","_a","e","applyFilter","_b","clearLibrary","_c","action","resetFilter","_d","handleUserListClick","LIBRARY_UPDATED_EVENT","ids","getLibraryIds","toggleClearButton","toggleEmptyState","movies","getMoviesByIds","error","targetGenre","filteredMovies","movie","movieMatchesGenre","libraryCardTemplate","reason","genreId","normalizedId","releaseYear","genresLabel","getGenres","overview","formatOverview","rating","votes","posterPath","poster","removeBtn","movieId","removeLibraryMovie","detailsBtn","openMovieModal","id","getMovieById","markup","modalTemplate","updateModalBtn","showModal","isEmpty","title","text","link","enabled"],"mappings":"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"}